#include <string.h>
#include <limits.h>
#include "assert.h"
#include "mem.h"
#include "atom.h"

#define NELEMS(x) ((sizeof(x)) / (sizeof((x)[0])))

static struct atom {
    struct atom* link;
    int len;
    char* str;
} *buckets[2048];

//调用标准库rand生成256个均匀分布的int随机数
static unsigned long scatter[] = {
    594677705, 1195694409, 1693396687, 2099321015, 740736339, 1953050891,
    888138965, 1753356963, 505504061, 1620718709, 1732953819, 1008204240,
    2073504906, 684421316, 1440332718, 1914781762, 1043835802, 1456952186,
    1169073443, 1651861702, 264212511, 2069536108, 873675158, 1080460732,
    1298361367, 1707478152, 950431207, 941301295, 1099645752, 499422094,
    596775081, 356423983, 933336562, 1766756219, 245008288, 728667661,
    657007199, 80734855, 1453654452, 919316657, 560497968, 571976598,
    1297596596, 1914347576, 627752263, 17277263, 294609784, 107877488,
    1605224817, 1158342803, 1742182879, 1948209434, 1103574709, 1563470226,
    498510995, 689372460, 2131290227, 1728144306, 806863399, 339690719,
    2050568209, 1996243521, 492193220, 1152571525, 136303005, 1579264099,
    779878641, 707021850, 224383959, 1122256260, 1796607483, 1329472894,
    1042959796, 1103010503, 85537392, 700913042, 698433510, 951507114,
    1987730778, 1316365396, 998719383, 1486815501, 638655127, 2021670318,
    936326770, 176705414, 613412892, 1627788651, 818941095, 229066617,
    1516546628, 969955507, 1663375890, 1231523676, 1341257231, 1323432957,
    1998781733, 1500955023, 415490621, 249762253, 728157987, 713412677,
    330534667, 853881292, 1056691905, 848423347, 1899415377, 100291997,
    811215501, 52512425, 672088219, 1440236030, 1949916443, 2138502977,
    254859940, 1200403380, 1099897746, 308674880, 388328636, 371818995,
    102090220, 1495568860, 1959215345, 177778495, 2014624831, 100410041,
    1401259374, 414824353, 1358333986, 1614180230, 961033052, 142646235,
    517597604, 567906544, 1687921781, 1079299556, 1610891035, 842287549,
    371686419, 1242751027, 863367907, 776093269, 270815877, 978919352,
    1733076183, 1406127271, 1724293346, 2113146111, 1295537099, 1378374893,
    1680577, 2023834707, 1954408379, 599847442, 446625125, 647373681,
    1221348737, 1966064920, 900098875, 1632599711, 900389451, 1631625428,
    1127161489, 12954418, 813532530, 514985203, 703395553, 340919153,
    1517399287, 1908041667, 1309907128, 545051776, 1160028302, 1876588560,
    1108738320, 1097806487, 1168772053, 1752875613, 722571581, 811718649,
    985470599, 1514904023, 1430813356, 785620871, 866294759, 1988789201,
    967040161, 1220219455, 575092379, 1829724102, 2010872949, 2068602716,
    1409805649, 1654443018, 448397719, 129760884, 1835633946, 1402391402,
    958873088, 1438745174, 1841760656, 1667123429, 866138453, 557657909,
    128616110, 1767911100, 160423054, 532277270, 2138230438, 1750957227,
    623109443, 217692825, 1432179748, 1576380487, 945542811, 1587920461,
    1318865344, 1985434003, 361320898, 225524326, 497200940, 473208646,
    1595897071, 145945228, 1287798206, 1316776137, 1362931120, 923895405,
    1731081819, 1936511624, 811394428, 414822528, 2138174412, 1227706952,
    1520428514, 1731308483, 918725729, 763271138, 1420660827, 1634840234,
    994205126, 1006711179, 1730188205, 1341347929, 173091890, 430664816,
    880487098, 1410239608, 1286698024, 2035696093, 1508599118, 1408499479,
    1610727851, 497778927, 1778204538, 1886182731
};

const char* Atom_new(const char* str, int len)
{
    unsigned long h;
    int i;
    struct atom* p;

    assert(str);
    assert(len >= 0);

    for (h = 0, i = 0; i < len; i++)
        //注意是unsigned char，char可能大于127情况下为负数
        h = (h << 1) + scatter[(unsigned char)str[i]];

    h %= NELEMS(buckets);

    for (p = buckets[h]; p; p = p->link)
        if (len == p->len) {
            for (i = 0; i < len && p->str[i] == str[i];)
                i++;

            if (i == len) //存在
                return p->str;
        }

    p = ALLOC(sizeof(*p) + len + 1);
    p->len = len;
    p->str = (char*)(p + 1);

    if (len > 0)
        memcpy(p->str, str, len);

    p->str[len] = '\0';
    p->link = buckets[h];
    buckets[h] = p;
}

const char* Atom_string(const char* str)
{
    assert(str);
    return Atom_new(str, strlen(str));
}

const char* Atom_int(long n)
{
    char str[43];
    char* s = str + sizeof str;
    unsigned long m;

    if (n == LONG_MIN)
        m = LONG_MAX + 1UL;
    else if (n < 0)
        m = -n;
    else
        m = n;

    do {
        *--s = m % 10 + '0';
    } while ((m / 10) > 0);

    if (n < 0)
        *--s = '-';

    return Atom_new(s, (str + sizeof str) - s);
}

int Atom_length(const char* str)
{
    struct atom* p;
    int i;

    assert(str);

    for (i = 0; i < NELEMS(buckets); ++i) //此检索方法复杂度M*N太高了
        for (p = buckets[i]; p; p = p->link)
            if (p->str == str)
                return p->len;

    assert(0);
    return 0;
}
